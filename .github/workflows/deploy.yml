# FGCU Canvas Data Engineering - CI/CD Pipeline
# =============================================
# Builds and deploys the Canvas ETL container to Snowflake Snowpark Container Registry
#
# Workflow triggers:
#   - Push to main branch
#   - Pull request to main branch
#   - Manual trigger with environment selection
#
# Prerequisites:
#   - Configure GitHub Secrets (see README.md)
#   - Snowflake image repository must exist
#   - Compute pool must be created

name: Deploy to Snowpark Container Registry

on:
  push:
    branches:
      - main
    paths:
      - 'container/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'container/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  REGISTRY_URL: ${{ secrets.SNOWFLAKE_ACCOUNT }}.registry.snowflakecomputing.com
  IMAGE_NAME: fgcu_canvas_demo/compute/canvas_images/canvas-etl
  DATABASE: FGCU_CANVAS_DEMO
  SCHEMA: COMPUTE

jobs:
  # ============================================
  # Job 1: Lint and Test
  # ============================================
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: container/requirements.txt
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r container/requirements.txt
          pip install pytest pytest-cov ruff mypy
          
      - name: Run Ruff Linter
        run: |
          ruff check container/app/ --output-format=github
        continue-on-error: true
        
      - name: Run Type Checks
        run: |
          mypy container/app/ --ignore-missing-imports --no-error-summary
        continue-on-error: true
        
      - name: Run Unit Tests
        run: |
          cd container
          python -m pytest tests/ -v --cov=app --cov-report=xml || echo "No tests found"
        continue-on-error: true
        
      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          files: container/coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================
  # Job 2: Build Container Image
  # ============================================
  build:
    name: Build Container
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Generate Image Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.environment || 'dev' }}
            
      - name: Build Container Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./container
          file: ./container/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
            
      - name: Run Container Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
        
      - name: Save Image for Push Job
        run: |
          docker save ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} > image.tar
          
      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image
          path: image.tar
          retention-days: 1

  # ============================================
  # Job 3: Push to Snowflake Registry
  # ============================================
  push:
    name: Push to Snowflake Registry
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: container-image
          
      - name: Load Docker Image
        run: docker load < image.tar
        
      - name: Install SnowCLI
        run: |
          pip install snowflake-cli-labs
          
      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml << EOF
          [connections.default]
          account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user = "${{ secrets.SNOWFLAKE_USER }}"
          password = "${{ secrets.SNOWFLAKE_PASSWORD }}"
          role = "${{ secrets.SNOWFLAKE_ROLE }}"
          database = "${{ env.DATABASE }}"
          schema = "${{ env.SCHEMA }}"
          EOF
          chmod 600 ~/.snowflake/config.toml
          
      - name: Login to Snowflake Registry
        run: |
          echo "${{ secrets.SNOWFLAKE_PASSWORD }}" | docker login \
            ${{ env.REGISTRY_URL }} \
            -u ${{ secrets.SNOWFLAKE_USER }} \
            --password-stdin
            
      - name: Tag Images for Registry
        run: |
          # Tag with commit SHA
          docker tag ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # Tag as latest if main branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            docker tag ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          fi
          
          # Tag with environment
          docker tag ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.environment || 'dev' }}
            
      - name: Push to Snowflake Registry
        run: |
          docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          fi
          
          docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.environment || 'dev' }}
          
      - name: Verify Push
        run: |
          snow sql -q "SHOW IMAGES IN IMAGE REPOSITORY ${{ env.DATABASE }}.${{ env.SCHEMA }}.CANVAS_IMAGES;"

  # ============================================
  # Job 4: Deploy Container Service
  # ============================================
  deploy:
    name: Deploy Service
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'prod'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install SnowCLI
        run: pip install snowflake-cli-labs
        
      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml << EOF
          [connections.default]
          account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user = "${{ secrets.SNOWFLAKE_USER }}"
          password = "${{ secrets.SNOWFLAKE_PASSWORD }}"
          role = "${{ secrets.SNOWFLAKE_ROLE }}"
          database = "${{ env.DATABASE }}"
          schema = "${{ env.SCHEMA }}"
          warehouse = "FGCU_TASK_WH"
          EOF
          chmod 600 ~/.snowflake/config.toml
          
      - name: Update Service Specification
        run: |
          # Generate updated service spec with new image tag
          cat > /tmp/service_spec.yaml << EOF
          spec:
            containers:
              - name: canvas-etl
                image: /${{ env.DATABASE }}/${{ env.SCHEMA }}/canvas_images/canvas-etl:${{ github.sha }}
                env:
                  SNOWFLAKE_DATABASE: ${{ env.DATABASE }}
                  SNOWFLAKE_SCHEMA_RAW: RAW
                  SNOWFLAKE_SCHEMA_CURATED: CURATED
                  LOG_LEVEL: INFO
                  DEPLOYMENT_SHA: ${{ github.sha }}
                  DEPLOYMENT_TIME: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
                resources:
                  requests:
                    cpu: 0.5
                    memory: 1Gi
                  limits:
                    cpu: 2
                    memory: 4Gi
                volumeMounts:
                  - name: data-volume
                    mountPath: /app/data
            volumes:
              - name: data-volume
                source: local
            endpoints:
              - name: etl-endpoint
                port: 8080
                public: false
          EOF
          
      - name: Deploy Service Update
        run: |
          # Suspend existing service
          snow sql -q "ALTER SERVICE IF EXISTS ${{ env.DATABASE }}.${{ env.SCHEMA }}.CANVAS_ETL_SERVICE SUSPEND;" || true
          
          # Recreate with new specification
          snow sql -q "
            CREATE OR REPLACE SERVICE ${{ env.DATABASE }}.${{ env.SCHEMA }}.CANVAS_ETL_SERVICE
              IN COMPUTE POOL FGCU_CANVAS_POOL
              FROM SPECIFICATION \$\$
              $(cat /tmp/service_spec.yaml)
              \$\$
              MIN_INSTANCES = 1
              MAX_INSTANCES = 2
              COMMENT = 'Canvas ETL Service - Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC") - SHA: ${{ github.sha }}'
          ;"
          
      - name: Verify Deployment
        run: |
          echo "Waiting for service to start..."
          sleep 30
          
          snow sql -q "SELECT SYSTEM\$GET_SERVICE_STATUS('${{ env.DATABASE }}.${{ env.SCHEMA }}.CANVAS_ETL_SERVICE');"
          
      - name: Log Deployment
        run: |
          snow sql -q "
            INSERT INTO ${{ env.DATABASE }}.AUDIT.ETL_RUN_LOG 
              (run_type, started_at, status, metadata)
            VALUES (
              'DEPLOYMENT',
              CURRENT_TIMESTAMP(),
              'COMPLETED',
              PARSE_JSON('{
                \"sha\": \"${{ github.sha }}\",
                \"branch\": \"${{ github.ref_name }}\",
                \"actor\": \"${{ github.actor }}\",
                \"run_id\": \"${{ github.run_id }}\"
              }')
            );
          "

  # ============================================
  # Job 5: Post-Deployment Validation
  # ============================================
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Install SnowCLI
        run: pip install snowflake-cli-labs
        
      - name: Configure SnowCLI
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml << EOF
          [connections.default]
          account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user = "${{ secrets.SNOWFLAKE_USER }}"
          password = "${{ secrets.SNOWFLAKE_PASSWORD }}"
          role = "${{ secrets.SNOWFLAKE_ROLE }}"
          database = "${{ env.DATABASE }}"
          schema = "${{ env.SCHEMA }}"
          EOF
          chmod 600 ~/.snowflake/config.toml
          
      - name: Check Service Health
        run: |
          # Wait for service to be ready
          for i in {1..10}; do
            STATUS=$(snow sql -q "SELECT SYSTEM\$GET_SERVICE_STATUS('${{ env.DATABASE }}.${{ env.SCHEMA }}.CANVAS_ETL_SERVICE');" --format json | jq -r '.[0]."SYSTEM$GET_SERVICE_STATUS(''FGCU_CANVAS_DEMO.COMPUTE.CANVAS_ETL_SERVICE'')"' || echo "UNKNOWN")
            echo "Service status: $STATUS"
            
            if echo "$STATUS" | grep -q "READY"; then
              echo "âœ… Service is healthy!"
              exit 0
            fi
            
            echo "Waiting for service to be ready... (attempt $i/10)"
            sleep 15
          done
          
          echo "âš ï¸ Service health check timed out"
          exit 1
          
      - name: Smoke Test - Call Health Endpoint
        run: |
          # Test the service function
          snow sql -q "SELECT ${{ env.DATABASE }}.${{ env.SCHEMA }}.GET_ETL_STATUS();" || echo "Service function not yet available"
          
      - name: Create Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed By** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Registry" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 6: Notify on Failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, build, push, deploy, validate]
    if: failure()
    
    steps:
      - name: Create Failure Summary
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment pipeline encountered an error." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY



